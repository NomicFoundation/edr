# Debug

## Backtrace

A Rust stack trace can be generated by adding the following line to a function:

```rust
println!("{}", std::backtrace::Backtrace::force_capture());
```

Make sure to add the `backtrace` crate to the development dependencies.

## VSCode for Rust

When using VSCode with the `rust-analyzer` extension, you can set breakpoints and debug Rust code directly from the editor.

Go to a Rust file with tests. Above a test function, you should see a "Run Test | ⚙️ Debug" option. Click on "⚙️ Debug" to start debugging.

## VSCode for Hardhat 2 with EDR

When using VSCode with the CodeLLDB extension, you can debug Hardhat tests that use EDR as the provider.

You will need to checkout the Hardhat v2 repository and the Hardhat project that you want to debug (e.g. OpenZeppelin Contracts) alongside the EDR repository. The directory structure should look something like this:

```
/workspaces
  /edr
  /hardhat
  /openzeppelin-contracts
```

### Build EDR in debug mode

Normally, `dev` builds of EDR emit limited debug information and optimize third-party dependencies like REVM. To ensure a smooth debugging experience, comment the following lines in `edr/Cargo.toml`:

```toml
[workspace]

[profile.dev]
# debug = 1

[profile.dev.package]

# EVM
# alloy-dyn-abi.opt-level = 3
# alloy-json-abi.opt-level = 3
# alloy-primitives.opt-level = 3
# alloy-sol-type-parser.opt-level = 3
# alloy-sol-types.opt-level = 3
# keccak.opt-level = 3
# revm-interpreter.opt-level = 3
# revm-precompile.opt-level = 3
# revm-primitives.opt-level = 3
# revm.opt-level = 3
# ruint.opt-level = 3
# sha2.opt-level = 3
# sha3.opt-level = 3
# tiny-keccak.opt-level = 3
# bitvec.opt-level = 3
```

Then build a debug build of EDR:

```bash
# In `edr/crates/edr_napi`
pnpm build:debug
```

### Link the repositories

To complete the setup, you need to `pnpm link` the three repositories together:

```bash
# In `hardhat/packages/hardhat-core`
pnpm link ../../../edr/crates/edr_napi
pnpm build

# In `openzeppelin-contracts`
pnpm link ../hardhat/packages/hardhat-core
```

### VSCode launch configuration

Create or edit the `.vscode/launch.json` file in the EDR VSCode workspace. Add the following configuration to the `configurations` array, adjusting paths as necessary:

```json
{
  "name": "Debug Hardhat v2 (OpenZeppelin Contracts)",
  "type": "lldb",
  "request": "launch",
  // Path to the Hardhat project to debug (in this case: OpenZeppelin Contracts)
  "cwd": "${workspaceFolder}/../openzeppelin-contracts",
  // Path to the Node.js executable
  "program": "/usr/local/share/nvm/versions/node/v22.21.1/bin/node",
  "args": [
    // Path to Hardhat's CLI.js
    "${workspaceFolder}/../hardhat/packages/hardhat-core/internal/cli/cli.js",
    "test",
    // Filter to a specific test file to debug (in this case: OpenZeppelin Contracts RSA.test.js)
    "${workspaceFolder}/../openzeppelin-contracts/test/utils/cryptography/RSA.test.js"
  ]
}
```

### Start debugging

You can now start debugging by selecting the "Debug Hardhat v2 (OpenZeppelin Contracts)" configuration in the VSCode debug panel and clicking the green play button.
